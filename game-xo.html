<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>XO</title>
	<link rel="stylesheet" href="all.css">
	<script>
	// [Subota]
	// TODO: Переписать выделив функцию инициализации поля и обработчиков на элементах управления
	// TODO: Сделать динамическое построение игрового поля
	// TODO: Переписать логику игры используя понятие игрового цикла (game loop)
	// TODO: Оптимизировать алгоритмы определения победителя, заполнения поля, хранения очков игры
	window.onload = function(){
		var board = document.querySelector('.board'),
			cells = board.querySelectorAll('.cell'),
			resetBtn = document.querySelector('.reset-game'),
			radios = document.querySelectorAll('.nav input[type="radio"]'),
			table = document.querySelector('.winners'),
			player1Node = document.querySelector('.count-player1'),
			player2Node = document.querySelector('.count-player2'),
			computerNode = document.querySelector('.count-computer'),
			isCross = true,
			selectedArrey = new Array(9),
			boardMatrix = [
				['','',''],
				['','',''],
				['','','']
			],
			isOver = false,
			counter = 0,
			cellNumber,
			line,
			column,
			isOnePlayer = false,
			filledArray = new Array(9),//массив для выбранных ячеек
			sq = 3;//размер поля 3*3;

		//todo доделать динамическое создание поля
		function createField(number){
			sq = number;

			var field = document.createElement('div');
			field.className = 'board';

			for(var i = 0; i < sq*sq ; i ++){
				var cell = document.createElement('div');
				cell.className = 'cell';
				field.appendChild(cell);
			}

			document.querySelector('.wrapper').appendChild(field);
		}
		createField(3);
		//todo добавить обработчики на созданное поле

		//узнать количество игроков
		function checkPlayers(){
			var noneIsSelected = true;
			for (var i = 0; i < radios.length; i++){
				if(radios[i].checked){
					isOnePlayer = radios[i].value !== "2players";
					noneIsSelected = false;
				}
				//если ничего не выбрано
				if(i == radios.length -1 && noneIsSelected){
					radios[0].checked = true;
					isOnePlayer = radios[0].value !== "2players";
				}
				// [Subota] Как насчет делегирования? Тогда нужен будет один обработчик вместо нескольких (на каждый radio)
				radios[i].addEventListener('change', function(){
					isOnePlayer = !isOnePlayer;
					resetGame();
				});
			}
		}
		checkPlayers();
		//заполняем ячейку
		function fillCell(e){
			if (isOver || !hasClass(e.target, 'cell')) return;
			if(!hasClass(e.target, 'zero') && !hasClass(e.target, 'cross')){
				addClass(e.target, isCross ? 'cross' : 'zero');
				addValueToMatrix(e.target);
				cellNumber = +getCellNumber(e.target);//номер ячейки
				checkWinner(cellNumber);
				isCross = !isCross;
				counter++;
				//ход компьютера
				if(counter < 9 && isOnePlayer){
					aiStep();
				}
			}
		}
		//проверить победителя
		function checkWinner(number){
			//если ячейка уже заполнена выйти
			if(filledArray[number] == -1 || filledArray[number] == 1) {
				return;
			} else {
				filledArray[number] = isCross ? -1 : 1;
			}

			//проверяем вертикаль
			if(filledArray[number] == filledArray[number - sq*2] && filledArray[number] == filledArray[number - sq]){
				isOver = true;
				console.log('end vertical up');
			}
			if(filledArray[number] == filledArray[number - sq] && filledArray[number] == filledArray[number + sq]){
				isOver = true;
				console.log('end vertical center');
			}
			if(filledArray[number] == filledArray[number + sq] && filledArray[number] == filledArray[number + 2*sq]){
				isOver = true;
				console.log('end vertical down');
			}
			//todo проверяем горизонталь
			//todo проверяем диагональ
		}
		function saveGameResult(winner){
			if(winner == "cross"){
				player1Node.innerHTML = parseFloat(player1Node.innerHTML) + 1;
			} else if(isOnePlayer){
				computerNode.innerHTML = parseFloat(computerNode.innerHTML) + 1;
			} else {
				player2Node.innerHTML = parseFloat(player2Node.innerHTML) + 1;
			}
		}
		//ход ИИ
		function aiStep(){
			if (isOver) return;
			var randomCell = Math.floor(Math.random()*9);
			recalсPosition(randomCell);
			//проверть заполнена ли ячейка
			if(!selectedArrey[randomCell]){
				aiFillCell();
			} else {
				//если заполнена ищем следующую пустую
				do{
					if(randomCell === 8) randomCell = -1;
					randomCell ++;
				} while(selectedArrey[randomCell]);
				aiFillCell();
			}
			function aiFillCell(){
				recalсPosition(randomCell);
				addClass(cells[randomCell], isCross ? 'cross' : 'zero');
				boardMatrix[line][column] = isCross ? 'cross' : 'zero';
				selectedArrey[randomCell] = true;
				checkWinner(randomCell);
				isCross = !isCross;
				counter ++;
			}
		}
		//добавить в матрицу значение .cell
		function addValueToMatrix(elem){
			cellNumber = getCellNumber(elem);
			recalсPosition(cellNumber);
			boardMatrix[line][column] = isCross ? 'cross' : 'zero';
			selectedArrey[cellNumber] = true;
		}
		//получить порядковый номер .cell в массиве
		function getCellNumber(elem){
			for(var i in cells){
				if (cells[i] == elem){
					return i;
				}
			}
		}
		//пересчет позиции ячейки
		function recalсPosition(cell){
			line = Math.floor(cell / 3);
			column = cell % 3;
		}
		//сброс игры
		function resetGame(){
			//удаляем классы с клеток
			for(var i = 0 ; i < cells.length ; i++){
				removeClass(cells[i], 'cross');
				removeClass(cells[i], 'zero');
				removeClass(cells[i], 'red');
			}
			//чистим матрицу
			for (var j = 0; j < boardMatrix.length; j++){
				for (var k = 0; k < boardMatrix[j].length; k++){
					boardMatrix[j][k] = '';
				}
			}
			isOver = false;
			isCross = true;
			counter = 0;
			//новый массив для занятых ячеек
			selectedArrey = new Array(9);
			filledArray = new Array(9);
		}
		//проверка класса
		function hasClass(elem,myClass){
			var classes = elem.className.split(" ");
			return classes.some(function(x){return x === myClass;});
		}
		//добавление класса
		function addClass(elem,myClass){
			var classes = elem.className.split(" ");
			if (!classes.some(function(x){return x === myClass;})){
				classes.push(myClass);
				elem.className=classes.join(' ');
			}
		}
		//удаление класса
		function removeClass(elem,myClass){
			var classes = elem.className.split(" ");
			for(i=0;i<classes.length;i++){
				while (classes[i] === myClass){
					classes.splice(i,1);
				}
			}
			elem.className = classes.join(' ');
		}
		board.addEventListener('click', function(e){
			fillCell(e);
		});
		resetBtn.addEventListener('click', function(){
			resetGame();
		});
	};
	</script>
</head>
<body>
	<h2>Крестики-нолики</h2>
	<div class="nav">
		<label><input type="radio" name="opponent" value="2players"> 2  игрока </label>
		<label><input type="radio" name="opponent" value="1player"> с компьютером </label>
	</div>
	<div class="wrapper">
		<div class="right-col">
			<table class="winners">
				<tr>
					<td>Игрок 1 (x)</td>
					<td><span class="count-player1">0</span></td>
				</tr>
				<tr>
					<td>Игрок 2 (o)</td>
					<td><span class="count-player2">0</span></td>
				</tr>
				<tr>
					<td>Компьютер (o)</td>
					<td><span class="count-computer">0</span></td>
				</tr>
			</table>
		</div>
		<div class="board">
			<div class="cell"></div>
			<div class="cell"></div>
			<div class="cell"></div>
			<div class="cell"></div>
			<div class="cell"></div>
			<div class="cell"></div>
			<div class="cell"></div>
			<div class="cell"></div>
			<div class="cell"></div>
		</div>
	</div>
	<div>
		<button class="reset-game">заново</button>
	</div>
</body>
</html>